<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MilEd.One - ×œ××™×“×” ×—×›××”</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root { --primary: #3498db; --skills: #1abc9c; --bg: #f4f7f6; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }

header { 
background: white; padding: 10px 20px; 
display: flex; justify-content: space-between; align-items: center; 
box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
}

.nav-links { display: flex; gap: 15px; }

.nav-btn { 
text-decoration: none; padding: 8px 15px; border-radius: 8px; 
font-size: 0.9rem; font-weight: 600; transition: 0.3s; 
}

.btn-courses { background: #eee; color: #333; }
.btn-skills { background: var(--skills); color: white; border: 2px solid var(--skills); }
.btn-skills:hover { background: white; color: var(--skills); }

.current-course { font-weight: 700; color: var(--primary); font-size: 1.1rem; }

#chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

.message { max-width: 85%; padding: 15px; border-radius: 15px; line-height: 1.6; font-size: 1rem; }

.user { align-self: flex-start; background: var(--primary); color: white; }

.ai { align-self: flex-end; background: #e9e9eb; color: #333; }

.loading-text { font-style: italic; color: #888; font-size: 0.8rem; }

.input-area { background: white; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; }

input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; }

button { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 10px; cursor: pointer; }

button:disabled { background: #ccc; }

#voice-btn.recording { background: #e74c3c; }
</style>

</head>

<body>

<header>

<div class="nav-links">
<a href="/students.html" class="nav-btn btn-courses">ğŸ“š ×”×§×•×¨×¡×™× ×©×œ×™</a>
<a href="/skills.html" class="nav-btn btn-skills">ğŸ” ××‘×—×•×Ÿ ×•××™×•×× ×•×™×•×ª</a>
</div>

<div id="course-title" class="current-course">×˜×•×¢×Ÿ...</div>

<div>MilEd.One</div>

</header>


<div id="chat-window">

<div id="welcome-msg" class="message ai">
×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨?
</div>

</div>


<div class="input-area">

<input id="user-input" placeholder="×›×ª×•×‘ ×©××œ×”..." onkeypress="handleKey(event)">

<button id="voice-btn">ğŸ¤</button>

<button id="send-btn" onclick="sendMessage()">×©×œ×—</button>

<!-- EXPORT BUTTON â€” ADDED -->
<button onclick="exportPrompt()">×™×™×¦× prompt</button>

</div>


<script>

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT STATE â€” ADDED
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.__LAST_EXPORT_PROMPT = null;


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// session identifiers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let studentId = sessionStorage.getItem('studentId');

if (!studentId){

studentId = 's_' + Math.random().toString(36).slice(2,10);

sessionStorage.setItem('studentId', studentId);

}


let sessionId = sessionStorage.getItem('sessionId');

if (!sessionId){

sessionId = 'sess_' + Math.random().toString(36).slice(2,10);

sessionStorage.setItem('sessionId', sessionId);

}


// facultyId (null ×œ×¡×˜×•×“× ×˜)

let facultyId = sessionStorage.getItem('facultyId') || null;


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// query params
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const params = new URLSearchParams(window.location.search);

const classId = params.get('classId');


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// chat state
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const chatWindow = document.getElementById('chat-window');

const input = document.getElementById('user-input');

const sendBtn = document.getElementById('send-btn');

const historyKey = `history_${classId}`;

let chatHistory = JSON.parse(sessionStorage.getItem(historyKey) || '[]');


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// render message
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderMessage(role, content){

const div = document.createElement('div');

div.className = 'message ' + (role === 'user' ? 'user' : 'ai');

div.innerHTML = role === 'user' ? content : marked.parse(content);

return div;

}


// restore history

if(chatHistory.length>0){

document.getElementById('welcome-msg')?.remove();

chatHistory.forEach(m => chatWindow.appendChild(renderMessage(m.role, m.content)));

}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// load config
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentBotType = null;

fetch('/config.json')

.then(r=>r.json())

.then(config=>{

for(let branch in config.branches){

const item = config.branches[branch].items?.[classId];

if(item){

currentBotType = item.botType;

document.getElementById('course-title').textContent = item.name;

break;

}

}

});


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// send message
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function sendMessage(){

if(!currentBotType){

alert("×”××¢×¨×›×ª ×¢×“×™×™×Ÿ × ×˜×¢× ×ª");

return;

}

const text = input.value.trim();

if(!text) return;


chatWindow.appendChild(renderMessage('user',text));


input.value="";

sendBtn.disabled=true;


const loading = document.createElement('div');

loading.className='message ai loading-text';

loading.innerText='×—×•×©×‘...';

chatWindow.appendChild(loading);


try{


const response = await fetch('/api/chat',{

method:'POST',

headers:{'Content-Type':'application/json'},

body:JSON.stringify({

message:text,

botType:currentBotType,

classId:classId,

studentId:studentId,

facultyId:facultyId,

sessionId:sessionId,

history:chatHistory

})

});


// authorization guard

if(response.status===403){

loading.remove();

chatWindow.appendChild(renderMessage(

'assistant',

"××™×Ÿ ×œ×š ×”×¨×©××” ×œ×”×©×ª××© ×‘×›×œ×™ ×–×”"

));

return;

}


const data = await response.json();


// SAVE PROMPT FOR EXPORT â€” ADDED
if(data.exportPrompt)
window.__LAST_EXPORT_PROMPT = data.exportPrompt;


loading.remove();


const reply = data.reply || "×©×’×™××”";


chatWindow.appendChild(renderMessage('assistant',reply));


chatHistory.push({role:'user',content:text});

chatHistory.push({role:'assistant',content:reply});

sessionStorage.setItem(historyKey, JSON.stringify(chatHistory));


}catch(e){

loading.remove();

chatWindow.appendChild(renderMessage(

'assistant',

"×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª"

));

}


sendBtn.disabled=false;

}


// enter key

function handleKey(e){

if(e.key==="Enter") sendMessage();

}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT FUNCTION â€” ADDED
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exportPrompt(){

if(!window.__LAST_EXPORT_PROMPT){

alert("××™×Ÿ prompt ×œ×™×™×¦×•× ×¢×“×™×™×Ÿ");

return;

}

const botName =
document.getElementById("course-title")?.innerText
|| "MilEd Bot";

const now =
new Date().toISOString();

const content =
`MilEd.One â€” Prompt Export
================================

Bot name: ${botName}
Exported at: ${now}

--------------------------------
SYSTEM PROMPT
--------------------------------

${window.__LAST_EXPORT_PROMPT}

--------------------------------
Generated via MilEd.One
--------------------------------
`;

const blob =
new Blob([content], {type:"text/plain;charset=utf-8"});

const url =
URL.createObjectURL(blob);

const a =
document.createElement("a");

a.href=url;

a.download=
botName.replace(/\s+/g,"_")+"_prompt.txt";

document.body.appendChild(a);

a.click();

document.body.removeChild(a);

URL.revokeObjectURL(url);

}

</script>


</body>

</html>
