<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MilEd.One -  </title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root { --primary: #3498db; --skills: #1abc9c; --bg: #f4f7f6; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }

header { 
background: white; padding: 10px 20px; 
display: flex; justify-content: space-between; align-items: center; 
box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
}

.nav-links { display: flex; gap: 15px; }

.nav-btn { 
text-decoration: none; padding: 8px 15px; border-radius: 8px; 
font-size: 0.9rem; font-weight: 600; transition: 0.3s; 
}

.btn-courses { background: #eee; color: #333; }
.btn-skills { background: var(--skills); color: white; border: 2px solid var(--skills); }
.btn-skills:hover { background: white; color: var(--skills); }

.current-course { font-weight: 700; color: var(--primary); font-size: 1.1rem; }

#chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

.message { max-width: 85%; padding: 15px; border-radius: 15px; line-height: 1.6; font-size: 1rem; }

.user { align-self: flex-start; background: var(--primary); color: white; }

.ai { align-self: flex-end; background: #e9e9eb; color: #333; }

.loading-text { font-style: italic; color: #888; font-size: 0.8rem; }

.input-area { background: white; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; }

input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; }

button { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 10px; cursor: pointer; }

button:disabled { background: #ccc; }

#voice-btn.recording { background: #e74c3c; }
</style>

</head>

<body>

<header>

<div class="nav-links">
<a href="/students.html" class="nav-btn btn-courses"> 拽专住 砖</a>
<a href="/skills.html" class="nav-btn btn-skills">  转</a>
</div>

<div id="course-title" class="current-course">注...</div>

<div>MilEd.One</div>

</header>


<div id="chat-window">

<div id="welcome-msg" class="message ai">
砖!   注专?
</div>

</div>


<div class="input-area">

<input id="user-input" placeholder="转 砖..." onkeypress="handleKey(event)">

<button id="voice-btn"></button>

<button id="send-btn" onclick="sendMessage()">砖</button>

</div>


<script>

// 
// session identifiers
// 

let studentId = sessionStorage.getItem('studentId');

if (!studentId){

studentId = 's_' + Math.random().toString(36).slice(2,10);

sessionStorage.setItem('studentId', studentId);

}


let sessionId = sessionStorage.getItem('sessionId');

if (!sessionId){

sessionId = 'sess_' + Math.random().toString(36).slice(2,10);

sessionStorage.setItem('sessionId', sessionId);

}


// facultyId (null 住)

let facultyId = sessionStorage.getItem('facultyId') || null;


// 
// query params
// 

const params = new URLSearchParams(window.location.search);

const classId = params.get('classId');


// 
// chat state
// 

const chatWindow = document.getElementById('chat-window');

const input = document.getElementById('user-input');

const sendBtn = document.getElementById('send-btn');

const historyKey = `history_${classId}`;

let chatHistory = JSON.parse(sessionStorage.getItem(historyKey) || '[]');


// 
// render message
// 

function renderMessage(role, content){

const div = document.createElement('div');

div.className = 'message ' + (role === 'user' ? 'user' : 'ai');

div.innerHTML = role === 'user' ? content : marked.parse(content);

return div;

}


// restore history

if(chatHistory.length>0){

document.getElementById('welcome-msg')?.remove();

chatHistory.forEach(m => chatWindow.appendChild(renderMessage(m.role, m.content)));

}


// 
// load config
// 

let currentBotType = null;

fetch('/config.json')

.then(r=>r.json())

.then(config=>{

for(let branch in config.branches){

const item = config.branches[branch].items?.[classId];

if(item){

currentBotType = item.botType;

document.getElementById('course-title').textContent = item.name;

break;

}

}

});


// 
// send message
// 

async function sendMessage(){

if(!currentBotType){

alert("注专转 注 注转");

return;

}

const text = input.value.trim();

if(!text) return;


chatWindow.appendChild(renderMessage('user',text));


input.value="";

sendBtn.disabled=true;


const loading = document.createElement('div');

loading.className='message ai loading-text';

loading.innerText='砖...';

chatWindow.appendChild(loading);


try{


const response = await fetch('/api/chat',{

method:'POST',

headers:{'Content-Type':'application/json'},

body:JSON.stringify({

message:text,

botType:currentBotType,

classId:classId,

studentId:studentId,

facultyId:facultyId,

sessionId:sessionId,

history:chatHistory

})

});


// authorization guard

if(response.status===403){

loading.remove();

chatWindow.appendChild(renderMessage(

'assistant',

"  专砖 砖转砖  "

));

return;

}


const data = await response.json();


loading.remove();


const reply = data.reply || "砖";


chatWindow.appendChild(renderMessage('assistant',reply));


chatHistory.push({role:'user',content:text});

chatHistory.push({role:'assistant',content:reply});

sessionStorage.setItem(historyKey, JSON.stringify(chatHistory));


}catch(e){

loading.remove();

chatWindow.appendChild(renderMessage(

'assistant',

"砖转 专 砖专转"

));

}


sendBtn.disabled=false;

}


// enter key

function handleKey(e){

if(e.key==="Enter") sendMessage();

}

</script>


</body>

</html>
