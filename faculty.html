<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>MilEd.One - סגל</title>

<style>

body
{
    font-family:'Segoe UI',sans-serif;
    background:#f4f7f6;
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
}

.container
{
    max-width:800px;
    width:90%;
    background:white;
    padding:40px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.05);
    text-align:center;
}

h1
{
    color:#9b59b6;
    font-size:2.2rem;
    margin-bottom:10px;
}

.subtitle
{
    color:#7f8c8d;
    margin-bottom:30px;
}

.grid
{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
}

.btn
{
    padding:25px;
    border-radius:15px;
    text-decoration:none;
    color:white;
    background:#9b59b6;
    font-weight:bold;
    transition:0.3s;
    display:flex;
    align-items:center;
    justify-content:center;
}

.btn:hover
{
    transform:translateY(-3px);
    background:#8e44ad;
}

.back-btn
{
    display:inline-block;
    margin-top:40px;
    color:#7f8c8d;
    text-decoration:none;
    font-weight:bold;
}

.error
{
    color:#e74c3c;
    margin-top:20px;
}

@media (max-width:600px)
{
    .grid
    {
        grid-template-columns:1fr;
    }
}

</style>

</head>


<body>


<div class="container">

<span style="font-weight:300;color:#000;">
MilEd.One
</span>

<h1 id="title">
טוען...
</h1>

<p id="subtitle" class="subtitle"></p>

<div id="list" class="grid"></div>

<div id="error" class="error"></div>

<a href="/" class="back-btn">
→ חזרה לדף הבית
</a>

</div>


<script>


/* =====================================================
   state
===================================================== */

let CONFIG=null;

let USER=null;

/* EXPORT SUPPORT — added */
const currentFacultyId =
    localStorage.getItem("facultyId") || null;



/* =====================================================
   auth check
===================================================== */

function checkAuth()
{
    const token=localStorage.getItem("miled_token");

    const role=localStorage.getItem("miled_role");

    const name=localStorage.getItem("miled_user");

    if(!token || role!=="faculty")
    {
        document.getElementById("error").innerText=
        "גישה מוגבלת לסגל בלבד";

        return false;
    }

    USER=
    {
        token,
        role,
        name
    };

    return true;
}



/* =====================================================
   load config with TTL protection
===================================================== */

async function loadConfig()
{
    try
    {
        const res=
        await fetch('/config.json?ts='+Date.now());

        if(!res.ok)
            throw new Error("config load failed");

        CONFIG=
        await res.json();

        initPage();
    }

    catch(err)
    {
        console.error(err);

        document.getElementById("error").innerText=
        "שגיאה בטעינת המערכת";
    }
}



/* =====================================================
   EXPORT FULL SYSTEM PROMPT — added
===================================================== */

async function exportSystemPrompt(botType, facultyId=null)
{
    try
    {
        const res=await fetch(
            "/.netlify/functions/chat?exportPrompt=true",
            {
                method:"POST",
                headers:
                {
                    "Content-Type":"application/json"
                },
                body:JSON.stringify(
                {
                    botType,
                    facultyId
                })
            });

        const data=await res.json();

        if(!data.fullSystemPrompt)
        {
            alert("לא ניתן לייצא את ה-System Prompt");
            return;
        }

        await navigator.clipboard.writeText(
            data.fullSystemPrompt
        );

        alert(
        "ה-System Prompt המלא הועתק ללוח.\n\n"+
        "ניתן כעת להדביק אותו ב-GPT או בכל מערכת אחרת."
        );
    }
    catch(e)
    {
        console.error(e);
        alert("שגיאה בייצוא");
    }
}



/* =====================================================
   init page
===================================================== */

function initPage()
{
    const faculty=CONFIG.branches.faculty;

    document.getElementById("title").innerText=
        faculty.title;

    document.getElementById("subtitle").innerText=
        faculty.subtitle;


    const container=
        document.getElementById("list");


    for(let id in faculty.items)
    {
        const bot=faculty.items[id];


        /* private bot guard */

        if(bot.private && USER.role!=="faculty")
            continue;


        const wrapper=document.createElement("div");

        wrapper.style.display="flex";
        wrapper.style.flexDirection="column";
        wrapper.style.gap="8px";


        const a=document.createElement("a");

        a.className="btn";

        a.href="/chat.html?class="+id;

        a.innerText=bot.name;


        const exportBtn=document.createElement("button");

        exportBtn.innerText="ייצוא System Prompt";

        exportBtn.style.padding="6px 12px";
        exportBtn.style.borderRadius="8px";
        exportBtn.style.border="none";
        exportBtn.style.cursor="pointer";
        exportBtn.style.background="#2c3e50";
        exportBtn.style.color="white";

        exportBtn.onclick=()=>
            exportSystemPrompt(bot.botType,currentFacultyId);


        wrapper.appendChild(a);

        wrapper.appendChild(exportBtn);

        container.appendChild(wrapper);
    }
}



/* =====================================================
   start
===================================================== */

if(checkAuth())
{
    loadConfig();
}



</script>


</body>
</html>
